# 설문조사 보고서 생성기 (Survey Report Generator) v4 - 체계적 문서

## 프로젝트 개요

### 목적
- **설문조사 데이터 자동 분석**: CSV 형태의 설문조사 데이터를 입력받아 HTML 형태의 종합 분석 보고서를 자동 생성
- **이메일 호환 최적화**: 특히 MS Outlook 2019 환경에서의 렌더링 호환성을 보장하는 HTML 생성
- **다양한 문항 유형 지원**: 객관식, 주관식, 평가형, 콘텐츠형, 목록형, 카드형, 이분형, 순위형 등 8가지 문항 유형 처리
- **세그먼트별 상세 분석**: 성별, 연령대, 계좌고객 여부 등 다양한 세그먼트별 교차 분석 제공

### 주요 기능
- **자동 문항 분류**: 문항 코드에 따른 자동 문항 유형 판별 및 적절한 시각화 방식 적용
- **히트맵 생성**: 객관식/평가형 문항에 대한 세그먼트별 교차 분석 히트맵
- **키워드 분석**: 주관식 문항의 자동 키워드 추출 및 긍정/부정/중립 분류
- **반응형 레이아웃**: 이메일 클라이언트 호환성을 고려한 테이블 기반 반응형 레이아웃
- **자동 이메일 발송**: 생성된 보고서를 지정된 수신자에게 자동 발송

## 입력 데이터 구조 및 처리 규칙

### CSV 파일 구조
- **기본 파일**: `data/20250902_sample_data.csv`
- **데이터 디렉토리**: `data/` 폴더 내 위치

### 주요 컬럼 해석

#### 문항 식별 및 분류
- **`qsit_sqn`** (숫자): 문항 그룹핑 키 및 오름차순 정렬 기준
- **`qsit_ttl`** (문자열): 문항 제목 표시
- **`main_ttl`** (문자열): 보고서 전체 제목
- **`qsit_type_ds_cd`** (숫자): 문항 타입 코드 → 내부 qtype 변환
  - 10: objective (객관식)
  - 20: subjective (주관식)  
  - 30: evaluation (평가형)
  - 40: content (콘텐츠형)
  - 50: list (목록형)
  - 60: card (카드형)
  - 70: binary (이분형)
  - 80: ranking (순위형)

#### 응답 데이터
- **`lkng_cntnt`** (문자열): 객관식 계열 문항의 선택지 라벨
- **`answ_cntnt`** (문자열): 주관식 문항의 자유 응답 내용
- **`text_yn`** (숫자): 객관식에서 기타 항목 여부 (1=기타항목)
- **`cust_id`** (문자열): 응답자 고유 식별자
- **`surv_date`** (문자열): 설문 수집 날짜 (YYYY-MM-DD, YYYY.MM.DD, YYYYMMDD 지원)

#### 세그먼트 분류 변수
- **`gndr_seg`**: 성별 세그먼트
- **`age_seg`**: 연령대 세그먼트  
- **`account_seg`**: 계좌고객 여부
- **`rgst_gap`**: 가입경과일
- **`vasp`**: VASP 연결 여부
- **`dp_seg`**: 수신상품 가입 여부
- **`loan_seg`**: 대출상품 가입 여부
- **`card_seg`**: 카드상품 가입 여부
- **`suv_seg`**: 서비스 이용 여부

### 데이터 처리 규칙

#### 무효값 필터링
다음 값들은 분석에서 제외: `".", "0", "-", "N/A", "NA", "null", "NULL", "미응답", "무응답"`

#### 응답 라벨 선택 로직
- **객관식 계열** (objective/satisfaction/content/list/card/binary/ranking): `lkng_cntnt` 우선, 없으면 `answ_cntnt`
  - 단, 객관식(코드 10)이고 `text_yn=1`이면 "기타"로 설정
- **주관식** (subjective): `answ_cntnt` 사용

#### 응답 정렬
- `answ_cntnt`에서 숫자 파싱 성공 시 숫자 우선 정렬
- 실패 시 문자열 오름차순 정렬

## 문항 유형별 처리 방식

### 1. 객관식 (objective, 코드 10)
- **시각화**: 일반 히트맵 (general_heatmap)
- **구조**: 세그먼트별 응답 분포를 색상 강도로 표현
- **색상**: 파란색 계열 팔레트 (HEATMAP_SHADES)
- **특수 처리**: `text_yn=1`인 항목은 "기타"로 분류

### 2. 주관식 (subjective, 코드 20)
- **시각화**: 키워드 분석 (subjective_keywords)
- **처리 과정**:
  1. 자유 응답 텍스트에서 키워드 추출
  2. 긍정/부정/중립 키워드 자동 분류
  3. 카테고리별 키워드 빈도 분석
  4. 임계값 이하 카테고리는 "기타"로 통합
- **제외 키워드**: `SUBJECTIVE_EXCLUDE_KEYWORDS`에 정의된 일반적 표현들
- **표시 제한**: 일반 카테고리 5개, 기타 카테고리 10개 키워드

### 3. 만족도 (satisfaction, 코드 30)
- **시각화**: 만족도 히트맵 (satisfaction_heatmap)
- **구조**: 
  - 행: 세그먼트별 분류 (전체, 성별, 연령대 등)
  - 열: 만족도 5단계 + 순만족도 + 평균점수
- **만족도 라벨**: "매우 만족해요", "만족해요", "보통이에요", "불만족해요", "매우 불만족해요"
- **평균점수**: 5점 척도로 변환하여 계산 (매우만족=5점, 매우불만족=1점)
- **색상**: 만족도 전용 색상 팔레트 (SUN_SATISFACTION_SHADES)

### 4. 콘텐츠형 (content, 코드 40)
- **시각화**: 세그별 패널 (seg_panels)
- **구조**: 각 세그먼트별로 개별 차트 생성

### 5. 목록형 (list, 코드 50)
- **시각화**: 세그별 패널 (seg_panels)
- **구조**: 각 세그먼트별로 개별 차트 생성

### 6. 카드형 (card, 코드 60)
- **시각화**: 세그별 패널 (seg_panels)
- **구조**: 각 세그먼트별로 개별 차트 생성

### 7. 이분형 (binary, 코드 70)
- **시각화**: 세그별 패널 (seg_panels)
- **구조**: 각 세그먼트별로 개별 차트 생성

### 8. 순위형 (ranking, 코드 80)
- **시각화**: 순위 차트 (ranking_chart)
- **구조**: 순위별 응답 분포를 시각화

## 보고서 레이아웃 및 컬럼 설정

### 전체 보고서 구조
- **최대 폭**: 940px
- **레이아웃**: 테이블 기반 (이메일 호환성)
- **폰트**: '맑은 고딕','Malgun Gothic','Apple SD Gothic Neo','Noto Sans CJK KR',-apple-system,BlinkMacSystemFont,sans-serif

### 히트맵 레이아웃

#### 만족도 히트맵
```
세그명(100px) | 값(110px) | 스페이서(반응형) | 히트맵열(70px×5) | 스페이서(반응형) | 순만족도(70px) | 평균점수(70px)
```
- **고정 폭**: 세그명(100px), 값(110px), 히트맵열(70px), 순만족도(70px), 평균점수(70px)
- **반응형**: 스페이서들 (최소 32px)

#### 일반 히트맵
```
세그명(100px) | 값(110px) | 스페이서(32px) | 히트맵열(반응형) | 기타(반응형, 최소60px)
```
- **고정 폭**: 세그명(100px), 값(110px), 스페이서(32px)
- **반응형**: 히트맵열, 기타열 (최소 60px)

### 주관식 키워드 레이아웃
- **카테고리 열**: 130px
- **긍부정 막대**: 220px
- **키워드 박스**: 반응형 (3등분)
- **숫자 표시**: 30px

## 프로젝트 파일 구조

### 핵심 실행 파일
- **`csv_report_generator3.py`**: 최신 메인 생성기 (현재 사용 중)
- **`csv_report_generator2.py`**: 이전 버전 (참고용)
- **`csv_report_generator.py`**: 기본 버전 (레거시)

### 보조 스크립트
- **`send_report_email.py`**: 보고서 자동 이메일 발송
- **`config.py`**: 이메일 설정 로더
- **`email_config.json`**: 이메일 계정 정보 (민감정보)

### 데이터 파일
- **`data/20250902_sample_data.csv`**: 기본 입력 데이터
- **`data/20250829_sample_data_raw.csv`**: 원본 데이터
- **`data/20250829_sample_data.xlsx`**: 엑셀 형태 데이터

### 출력 파일
- **`reports/`**: 생성된 HTML 보고서 저장 폴더
- **`reports/report3_YYYYMMDD.html`**: 최신 보고서 (csv_report_generator3.py 출력)

### 문서 파일
- **`work_history.md`**: 작업 이력 (기존)
- **`work_history2.md`**: 체계적 문서 (현재 파일)
- **`README.md`**: 프로젝트 개요

### 기타 파일
- **`email_optimized_generator.py`**: 이메일 최적화 생성기
- **`email_report_sender.py`**: 이메일 발송기
- **`report_generator.py`**: 템플릿 기반 생성기
- **`simple_report_generator.py`**: 심플 생성기

## 실행 방법

### 1. 환경 준비
```bash
# 작업 디렉터리 이동
cd F:\GitHub\kbank-ux\survey_report

# Python 환경 확인 (Python 3.7+ 필요)
python --version
```

### 2. 보고서 생성
```bash
# 최신 버전으로 보고서 생성
python csv_report_generator3.py

# 출력: reports/report3_YYYYMMDD.html
```

### 3. 이메일 발송
```bash
# 최신 보고서 자동 발송
python send_report_email.py

# 최초 실행 시 email_config.json 설정 필요
```

### 4. 다른 버전 실행 (참고용)
```bash
# 이전 버전
python csv_report_generator2.py

# 기본 버전
python csv_report_generator.py
```

## 환경변수 및 설정

### 레이아웃 설정 (LAYOUT_CONFIG)
```python
LAYOUT_CONFIG = [
    # 1행: 성별(2) | 계좌고객(2)
    [{"title": "① 성별", "seg": "gndr_seg", "buckets": 2},
     {"title": "② 계좌고객 여부", "seg": "account_seg", "buckets": 2}],
    # 2행: 연령대(7) 단독
    [{"title": "③ 연령대", "seg": "age_seg", "buckets": 7}],
    # ... 추가 행들
]
```

### 파일 경로 설정
- **DATA_DIR**: 데이터 파일 저장 디렉토리
- **CSV_FILE_NAME**: 기본 CSV 파일명
- **DEFAULT_CSV_PATH**: 기본 CSV 파일 전체 경로

### 주관식 분석 설정
- **SUBJECTIVE_EXCLUDE_CATEGORIES**: 제외할 카테고리 목록
- **SUBJECTIVE_EXCLUDE_KEYWORDS**: 제외할 키워드 목록
- **SUBJECTIVE_OTHER_THRESHOLD**: 기타 분류 임계값 (건수)
- **SUBJECTIVE_OTHER_PERCENT_THRESHOLD**: 기타 분류 임계값 (비율)
- **SUBJECTIVE_KEYWORDS_LIMIT**: 일반 카테고리 키워드 표시 개수
- **SUBJECTIVE_KEYWORDS_LIMIT_OTHER**: 기타 카테고리 키워드 표시 개수

### 색상 팔레트 설정
- **PRIMARY_PALETTE**: 기본 차트 색상 (블루 계열)
- **CONTRAST_PALETTE**: 대비 색상 (레드 계열)
- **HEATMAP_SHADES**: 일반 히트맵 색상 (11단계)
- **GRAYSCALE_SHADES**: 그레이스케일 히트맵 색상 (11단계)
- **SUN_SATISFACTION_SHADES**: 만족도 히트맵 색상

### 히트맵 색상 변환 설정
- **HEATMAP_GAMMA**: 감마 보정 (1.0 = 선형)
- **HEATMAP_ALPHA**: 끝단 강조 강도 (0<alpha<1)
- **HEATMAP_MIDRANGE_GAIN**: 중간 구간 대비 증폭 (1.40)
- **GRAYSCALE_THRESHOLD_PERCENT**: 그레이스케일 적용 임계값 (0.5%)

### 만족도 분석 설정
- **SATISF_LABELS**: 만족도 표준 라벨 순서
- **SATISFACTION_TRIGGERS**: 만족도 히트맵 분류 키워드

## 자주 발생하는 오류 및 해결방법

### 1. 파일 경로 오류
**오류**: `can't open file 'csv_report_generator3.py'`
**원인**: 작업 디렉터리가 잘못됨
**해결**: `cd F:\GitHub\kbank-ux\survey_report` 실행

### 2. PowerShell 명령어 오류
**오류**: `&& token is not a valid statement separator`
**원인**: PowerShell에서 `&&` 사용 불가
**해결**: `;` 사용 또는 명령어 분리 실행

### 3. Git 커밋 출력 깨짐
**오류**: 한글 커밋 메시지가 깨져서 표시
**원인**: 터미널 인코딩 문제
**해결**: 기능상 문제없음, 표시만 깨짐

### 4. Git 브랜치 오류
**오류**: `fatal: couldn't find remote ref main`
**원인**: 기본 브랜치가 `master`임
**해결**: `git pull origin master` 사용

### 5. 이메일 발송 실패
**오류**: SMTP 인증 실패
**원인**: `email_config.json` 설정 오류
**해결**: 
- Gmail 앱 비밀번호 사용
- 수신자 주소 형식 확인
- 방화벽/보안 설정 확인

### 6. CSV 파일 인코딩 오류
**오류**: 한글 데이터가 깨져서 표시
**원인**: CSV 파일 인코딩 문제
**해결**: UTF-8 인코딩으로 저장

### 7. 이메일 클라이언트 스타일 미적용
**오류**: `<head>`의 스타일이 적용되지 않음
**원인**: 일부 메일 클라이언트의 `<head>` 무시 이슈
**해결**: `<style>`을 `<body>`에 위치시킴

### 8. Outlook 2019에서 라벨/막대 정렬 깨짐
**오류**: 절대배치/transform 사용으로 인한 렌더링 문제
**원인**: Outlook의 CSS 지원 제한
**해결**: 절대배치/transform 제거, 테이블 레이아웃 고정

### 9. 대용량 문자열 편집 실패
**오류**: 큰 변경사항 적용 시 오류
**원인**: 메모리 또는 처리 한계
**해결**: 큰 변경은 단계적으로 나누어 적용

### 10. 메모리 부족 오류
**오류**: 대용량 데이터 처리 시 메모리 부족
**원인**: 데이터 크기 초과
**해결**: 
- 데이터 분할 처리
- 메모리 사용량 최적화
- 서버 환경에서 실행

## 추가 기능 및 특수 처리

### 동적 색상 적용
- **배경색 기반 텍스트 색상**: 배경이 어두우면 흰색, 밝으면 검은색 텍스트
- **빨간색 동적 조정**: 배경이 어두우면 밝은 빨간색, 밝으면 진한 빨간색

### 평균점수 차이 표시
- **형식**: `x.x (▲Y.Y%)` 또는 `x.x (▼Y.Y%)`
- **동일 판정**: 절대값 차이 < 0.001인 경우 "(동일)" 표시
- **색상**: 평균보다 높으면 빨간색, 낮으면 기본색

### 그레이스케일 적용 조건
- **n이 부족한 행**: 전체 응답의 0.5% 미만
- **기타 열**: 일반 히트맵의 기타 열
- **색상**: GRAYSCALE_SHADES 팔레트 사용

### 이메일 호환성 최적화
- **테이블 기반 레이아웃**: 모든 레이아웃을 `<table>` 태그로 구성
- **인라인 CSS**: 모든 스타일을 인라인으로 적용
- **조건부 주석**: Outlook 전용 스타일 적용
- **폰트 스택**: 크로스 플랫폼 호환 폰트 설정

### 반응형 레이아웃
- **고정 폭**: 세그명, 값, 스페이서 등 핵심 열
- **반응형**: 히트맵 열, 순만족도, 평균점수, 기타 열
- **최소 폭**: 반응형 열들의 최소 크기 보장

## 성능 최적화

### 코드 최적화
- **불필요한 함수 제거**: 사용하지 않는 함수들 정리
- **헬퍼 함수 활용**: 반복 계산을 헬퍼 함수로 통합
- **변수 재사용**: 중복 계산 방지

### 메모리 최적화
- **데이터 구조 최적화**: 효율적인 데이터 구조 사용
- **가비지 컬렉션**: 불필요한 객체 정리
- **스트리밍 처리**: 대용량 데이터 처리 시 스트리밍 방식 적용

### 렌더링 최적화
- **CSS 최적화**: 불필요한 스타일 제거
- **HTML 구조 최적화**: 효율적인 마크업 구조
- **이미지 최적화**: 인라인 이미지 사용 최소화

## 보안 및 개인정보 보호

### 민감정보 처리
- **이메일 설정**: `email_config.json`에 계정 정보 저장
- **Git 제외**: 민감정보 파일은 `.gitignore`에 추가
- **환경변수**: 가능한 경우 환경변수 사용

### 데이터 보호
- **로컬 처리**: 모든 데이터 처리를 로컬에서 수행
- **임시 파일**: 처리 후 임시 파일 자동 삭제
- **접근 제어**: 필요한 권한만 부여

## 레거시 생성기 정보

### csv_report_generator.py (기본 버전)
- **반응형 브레이크포인트**: 가로 860px 미만에서 1열로 전환, 그 이상은 2열 유지
- **최대 폭**: 외곽 컨테이너 `max-width:1080px`
- **2열 폭 비례 계산**: 같은 행의 두 그래프는 각 `buckets` 수에 비례해 픽셀폭을 동적으로 배분
- **응답통계**: 100% 누적 가로 막대 (막대 높이 110px)
- **상세 그래프**: 100% 누적 세로 막대 (x축=세그 값, y축=%)
- **보조막대/라벨**: 메인 막대 상단에 평균값 "Average x.x" 표시
- **커넥터**: 이메일 호환 스텝형 커넥터 유지
- **출력 파일명**: `reports/report_YYYYMMDD.html`

### csv_report_generator2.py (향상판)
- **커넥터 제거**: 보조막대-메인막대 연결용 1px 커넥터 완전 삭제
- **레이아웃 설정**: `LAYOUT_CONFIG`로 행/열/폭비를 선언적으로 제어
- **이메일 호환성**: `<style>`을 `<body>` 내부에 배치
- **최소 폭 보장**: `min-width:840px` 및 MSO 조건부 주석
- **2열 간격**: 12px 내부 갭 셀 삽입
- **출력 파일명**: `reports/report2_YYYYMMDD.html`

### 생성기 간 차이점
- **csv_report_generator.py**: 커넥터 유지, 860px 브레이크포인트, max-width 1080px
- **csv_report_generator2.py**: 커넥터 제거, 12px 간격, 최소폭 840px, LAYOUT_CONFIG
- **csv_report_generator3.py**: 만족도 히트맵, 평균점수 계산, 반응형 레이아웃

## Git 운영

### 브랜치 관리
- **기본 브랜치**: `master`
- **원격 저장소**: `https://github.com/kbank-ux/survey-report.git`

### 동기화 명령어
```bash
# 원격 저장소에서 최신 변경사항 가져오기
git pull origin master

# 변경사항 커밋 및 푸시
git add -A
git commit -m "feat(report3): <변경 요약>"
git push origin master
```

### 커밋 메시지 규칙
- **형식**: `feat(report3): <변경 요약>`
- **예시**: `feat(report3): 평균점수 계산 정확도 개선`

## 확장 가능성

### 새로운 문항 유형 추가
1. `GRAPH_TYPE_BY_QTYPE`에 새 유형 추가
2. 해당 유형의 처리 함수 구현
3. 시각화 방식 정의

### 새로운 세그먼트 추가
1. `LAYOUT_CONFIG`에 새 세그먼트 추가
2. CSV 컬럼 매핑 확인
3. 세그먼트별 처리 로직 구현

### 새로운 시각화 방식 추가
1. 시각화 함수 구현
2. 색상 팔레트 정의
3. 레이아웃 설정 추가

## 유지보수 가이드

### 정기 점검 항목
- **데이터 품질**: CSV 파일 형식 및 내용 확인
- **이메일 설정**: 발송 계정 상태 확인
- **출력 품질**: 생성된 HTML 보고서 검토
- **성능**: 처리 시간 및 메모리 사용량 모니터링

### 업데이트 절차
1. **백업**: 기존 파일 백업
2. **테스트**: 개발 환경에서 테스트
3. **배포**: 프로덕션 환경 적용
4. **검증**: 결과 확인 및 피드백 수집

### 문제 해결 프로세스
1. **오류 로그 확인**: 상세 오류 메시지 분석
2. **데이터 검증**: 입력 데이터 무결성 확인
3. **설정 확인**: 환경 설정 및 파라미터 검토
4. **코드 검토**: 로직 및 알고리즘 점검
5. **테스트**: 수정 후 재테스트

## 향후 작업 가이드 및 체크리스트

### 작업 완료 시 체크리스트
- [ ] `work_history2.md` 상단의 변경 이력 섹션 업데이트
- [ ] `LAYOUT_CONFIG` 변경 시 의도/근거를 함께 기록
- [ ] 팔레트/폰트/간격 등 스타일 정책 변경 시 영향 범위 요약
- [ ] Outlook 실기 테스트 스크린샷 캡처/링크(가능 시) 기록
- [ ] `send_report_email.py` 사용 시 `email_config.json` 보안 유지 및 갱신 절차 기록

### 코드 변경 시 주의사항
- **이메일 호환성**: 모든 변경사항은 Outlook 2019에서 테스트 필요
- **반응형 레이아웃**: 다양한 화면 크기에서 테스트
- **색상 접근성**: 색맹 사용자를 고려한 색상 대비 확인
- **성능**: 대용량 데이터 처리 시 메모리 사용량 모니터링

### 데이터 처리 시 주의사항
- **인코딩**: CSV 파일은 반드시 UTF-8 인코딩 사용
- **데이터 무결성**: 중복 제거 및 무효값 필터링 확인
- **개인정보 보호**: 민감한 개인정보는 마스킹 처리
- **백업**: 중요한 데이터 변경 전 백업 필수

### 배포 시 체크리스트
- [ ] 개발 환경에서 충분한 테스트 완료
- [ ] 이메일 발송 테스트 완료
- [ ] 다양한 이메일 클라이언트에서 렌더링 확인
- [ ] Git 커밋 및 푸시 완료
- [ ] 관련 문서 업데이트 완료

## 참고 자료

### 관련 문서
- **기존 작업 이력**: `work_history.md`
- **프로젝트 개요**: `README.md`
- **이메일 설정**: `email_config.json` (민감정보)

### 외부 참고 자료
- **HTML 이메일 호환성**: Outlook 2019 CSS 지원 제한사항
- **Python CSV 처리**: `csv` 모듈 공식 문서
- **Git 운영**: GitHub 공식 가이드

### 연락처 및 지원
- **프로젝트 저장소**: `https://github.com/kbank-ux/survey-report`
- **이슈 트래킹**: GitHub Issues 활용
- **문서화**: 모든 변경사항은 이 문서에 기록

## 2025-01-08 교차분석 엣지케이스 기능 추가

### 새로운 기능
- **교차분석 엣지케이스 분석**: 주관식을 제외한 문항들에 대해 세그먼트 간 교차분석을 수행하여 전체 대비 차이가 큰 케이스를 자동 탐지
- **문항별 교차분석**: 각 문항의 히트맵 아래에 해당 문항의 교차분석 결과를 표시
- **다차원 교차분석**: 2차원과 3차원 교차분석을 지원하여 복잡한 세그먼트 조합 분석 가능

### 환경변수 설정
```python
# 교차분석 최대 차원 (2차원, 3차원 등)
CROSS_ANALYSIS_MAX_DIMENSIONS = 3

# 교차분석 차이 임계값 (전체 대비 차이 %)
CROSS_ANALYSIS_DIFFERENCE_THRESHOLD = 15.0

# 교차분석 최소 응답 수 (신뢰성 확보)
CROSS_ANALYSIS_MIN_RESPONSES = 10

# 교차분석 결과 최대 표시 개수
CROSS_ANALYSIS_MAX_RESULTS = 20
```

### 분석 대상
- **세그먼트**: 성별, 계좌고객, 연령대, 가입경과일, VASP 연결, 수신상품 가입, 대출상품 가입, 카드상품 가입, 서비스 이용
- **문항 유형**: 객관식, 만족도형 (주관식 제외)
- **조합 방식**: 2차원부터 최대 차원까지 모든 가능한 세그먼트 조합

### 표시 형식
- **위치**: 각 문항의 히트맵 바로 아래
- **구조**: 테이블 형태로 답변, 전체 비율, 세그조합 비율, 차이, 응답수 표시
- **색상 코딩**: 차이 크기에 따라 빨간색(30%+), 주황색(20%+), 노란색(15%+) 구분
- **세그먼트 조합**: 한글명으로 변환하여 "성별: 남성 | 연령대: 30대" 형태로 표시

### 성능 최적화
- **조합 수 제한**: 세그먼트 조합이 20개를 초과하면 상위 20개만 분석
- **값 조합 제한**: 각 세그먼트의 값 조합이 50개를 초과하면 해당 조합 건너뛰기
- **차원 제한**: 성능을 위해 실제로는 최대 2차원까지만 분석
- **전체 비율 필터링**: 전체 비율이 1% 미만이거나 99% 초과인 경우 분석 제외

### 활용 방안
- **이상 패턴 탐지**: 특정 세그먼트 조합에서 예상과 다른 응답 패턴 발견
- **타겟 분석**: 특정 고객군의 응답 특성 파악
- **서비스 개선**: 차이가 큰 세그먼트를 중심으로 한 맞춤형 서비스 개발
- **마케팅 전략**: 세그먼트별 차별화된 마케팅 전략 수립

## 2025-01-09 업데이트

### 세그먼트 명칭 치환 시스템 개선
- **문제**: 교차분석에서 세그먼트 값들이 "1~3개", "신용", "4개 이상" 등으로 표시되어 의미 파악이 어려움
- **해결**: 
  - `get_segment_display_value()` 공통 함수 생성
  - 원본 값으로 먼저 매핑 시도 후 clean_value로 매핑하는 이중 매핑 로직 구현
  - 누락된 매핑 추가 ("03.신용" → "신용카드 가입" 등)
- **결과**: 모든 교차분석에서 세그먼트 값이 사용자 친화적인 형태로 표시

### 교차분석 Sentiment 필터링 구현
- **문제**: 교차분석에서 긍정/부정/중립 감정이 구분 없이 모두 표시됨
- **해결**: 
  - `_extract_comments_for_segment_combination` 함수에 `allowed_sentiments` 매개변수 추가
  - 평균 상회: 긍정 + 중립만 표시
  - 평균 하회: 부정 + 중립만 표시
- **결과**: 교차분석에서 의미 있는 감정별 키워드만 표시되어 더 정확한 분석 가능

### 일반 교차분석 테이블 레이아웃 개선
- **문제**: "평균 상회"와 "평균 하회" 컬럼의 너비가 균등하지 않음
- **해결**: 
  - `table-layout:fixed` 추가로 이메일 호환성 향상
  - 구분열: `width:120px` 고정
  - 평균 상회/하회: `width:calc((100% - 120px) / 2)`로 정확히 균등 분할
- **결과**: 모든 이메일 클라이언트에서 일관된 테이블 레이아웃 제공

---

## v4 업데이트 내역 (2025-01-10)

### 주요 변경사항
1. **"만족도형" → "평가형" 용어 변경**
   - 모든 변수명, 함수명, 주석에서 "만족도형"을 "평가형"으로 변경
   - 사용자 인터페이스에서도 "만족도" 대신 "평가형"으로 표시

2. **문항 타입 표시 로직 개선**
   - 객관식 문항이지만 평가형 패턴인 경우 "평가형"으로 표시
   - 기존: "1번 문항 | 객관식"
   - 변경: "1번 문항 | 평가형" (평가형 패턴 감지 시)
   - 평가형 패턴: 만족도형(매우 만족/만족/보통/불만족/매우 불만족) 또는 동의도형(매우 그렇다/그렇다/보통이다/그렇지 않다/매우 그렇지 않다)

3. **파일 구조 변경**
   - `csv_report_generator3.py` → `csv_report_generator4.py`로 복사
   - `work_history2.md` → `work_history4.md`로 복사

### 기술적 세부사항
- `question_type_label()` 함수에서 "만족도" → "평가형" 반환값 변경
- `build_objective_evaluation_heatmap()` 함수의 기본 제목을 "평가형 문항"으로 변경
- 모든 영어 변수명/함수명에서 "satisfaction" → "evaluation"으로 변경
- 상수명 변경: `SATISF_LABELS` → `EVAL_LABELS`, `SATISFACTION_TRIGGERS` → `EVALUATION_TRIGGERS`
- **새로운 평가형 패턴 감지 함수 `is_evaluation_pattern()` 추가**
  - 만족도형과 동의도형 패턴을 모두 감지
  - 라벨의 60% 이상이 평가형 키워드 포함 + "매우"와 "보통" 키워드 모두 포함 조건
- **보고서 상단 문항 수 통계 개선**
  - 객관식 중 평가형 패턴인 문항을 별도로 "평가형"으로 카운트
  - 기존: "문항 수: 총 3건 (객관식 2건, 주관식 1건, 순위형 0건)"
  - 변경: "문항 수: 총 3건 (객관식 1건, 주관식 1건, 평가형 1건, 순위형 0건)"
- **동적 컴포넌트 시스템 도입**
  - 문항 타입별로 표시할 컴포넌트를 환경변수로 설정 가능
  - `QUESTION_TYPE_COMPONENTS` 설정으로 각 문항 타입별 컴포넌트 구성 정의
  - `build_question_components()` 함수로 설정에 따라 동적으로 보고서 생성
  - **qsit_type_ds_cd 값에 따른 정확한 문항 타입 매핑**
    - `get_question_type()` 함수로 qsit_type_ds_cd → 문항 타입 매핑
    - 객관식이지만 평가형 패턴인 경우 자동으로 evaluation 타입으로 변경
    - 환경변수 설정에 따라 해당 문항 타입의 컴포넌트들이 자동 적용
  - 교차분석 관련 주석 및 함수 설명에서 용어 통일

## 동적 컴포넌트 시스템 상세

### 컴포넌트 타입 정의
```python
COMPONENT_TYPES = {
    "general_stats": "일반형 응답통계",      # 기본 응답 통계 (비율, 응답수 등)
    "general_heatmap": "일반형 히트맵",      # 세그먼트별 교차분석 히트맵
    "evaluation_heatmap": "평가형 히트맵",   # 평가형 전용 히트맵 (순만족도 포함)
    "ranking_stats": "순위형 응답통계",      # 순위별 응답 통계
    "ranking_chart": "순위형 차트",          # 순위 시각화 차트
    "subjective_summary": "주관식 요약",     # 키워드 분석 및 요약
}
```

### 문항 타입별 컴포넌트 구성
```python
QUESTION_TYPE_COMPONENTS = {
    "objective": ["general_stats", "general_heatmap"],           # 객관식
    "evaluation": ["general_stats", "evaluation_heatmap"],       # 평가형
    "card": ["general_stats", "general_heatmap"],                # 카드형
    "binary": ["general_stats", "general_heatmap"],              # 이분형
    "ranking": ["ranking_stats", "ranking_chart"],               # 순위형
    "subjective": ["subjective_summary"],                        # 주관식
    "content": ["general_stats", "general_heatmap"],             # 콘텐츠형
    "list": ["general_stats", "general_heatmap"],                # 목록형
}
```

### 사용법
1. `QUESTION_TYPE_COMPONENTS` 설정을 수정하여 원하는 컴포넌트 구성 변경
2. 새로운 컴포넌트 타입 추가 시 `COMPONENT_TYPES`에 정의하고 `build_question_components()` 함수에 처리 로직 추가
3. 기존 호환성을 위해 `GRAPH_TYPE_BY_QTYPE` 매핑도 유지

## v4 최종 업데이트 내역 (2025-01-10)

### 완전한 동적 컴포넌트 시스템 구현
1. **하드코딩된 컴포넌트 렌더링 완전 제거**
   - `generate_html` 함수에서 기존의 하드코딩된 `if/elif` 블록들을 모두 제거
   - fallback 컴포넌트 렌더링 로직(`LAYOUT_CONFIG` 기반) 완전 제거
   - 모든 컴포넌트 렌더링이 `build_question_components()` 함수를 통해서만 수행되도록 통일

2. **동적 컴포넌트 시스템 완성**
   - `QUESTION_TYPE_COMPONENTS` 환경변수 설정이 모든 컴포넌트 렌더링의 유일한 기준이 됨
   - 문항 타입별로 설정된 컴포넌트들이 자동으로 적용됨
   - 새로운 컴포넌트 타입 추가 시 `COMPONENT_TYPES`와 `build_question_components()` 함수만 수정하면 됨

3. **테스트 결과 확인**
   - 보고서 생성 성공: "문항 수: 총 3건 (객관식 1건, 주관식 1건, 평가형 1건, 순위형 0건)"
   - 평가형 문항이 올바르게 "평가형"으로 분류되어 표시됨
   - 주관식 문항이 "주관식 요약" 컴포넌트로 올바르게 렌더링됨
   - 모든 문항 타입이 설정된 컴포넌트 구성에 따라 동적으로 렌더링됨

### 기술적 개선사항
- **코드 일관성**: 모든 컴포넌트 렌더링이 단일 함수(`build_question_components`)를 통해 수행
- **유지보수성**: 새로운 문항 타입이나 컴포넌트 추가 시 환경변수 설정만 변경하면 됨
- **확장성**: 컴포넌트 타입과 문항 타입별 구성을 독립적으로 관리 가능
- **테스트 완료**: 실제 데이터로 보고서 생성 테스트 성공

---

*이 문서는 `csv_report_generator4.py` 기준으로 작성되었으며, 프로젝트의 현재 상태를 반영합니다.*
*업데이트 시 이 문서도 함께 갱신해 주세요.*
*마지막 업데이트: 2025-01-10 (들여쓰기 오류 수정)*

## v4 최신 업데이트 내역 (2025-01-10)

### 문항 목록 표시 제거
- **변경사항**: 보고서 헤더에서 문항별 상세 목록 표시 제거
- **이유**: 사용자 요청에 따라 불필요한 정보 제거
- **영향**: 보고서 헤더가 더 간결해짐

### 문항 유형 분류 수정
- **문제**: 2번 보고서에서 카드형, 이분형이 순위형으로 잘못 분류됨
- **원인**: `qtype_counts` 딕셔너리에 모든 문항 유형이 포함되지 않음
- **해결**: 
  - `qtype_counts`에 모든 문항 유형 추가: `objective`, `subjective`, `evaluation`, `content`, `list`, `card`, `binary`, `ranking`
  - 문항 유형 분류 로직 단순화: `objective`가 아닌 경우 해당 유형으로 직접 분류
- **결과**: 모든 문항 유형이 정확하게 분류됨

### 히트맵 색상 수정
- **문제**: 히트맵에서 높은 숫자가 더 어두운 색으로 표시됨
- **원인**: 
  - `HEATMAP_SHADES` 팔레트의 0% 색상이 잘못됨
  - `_shade_for_pct_dynamic` 함수에 비선형 S-curve 변환 적용
- **해결**:
  - `HEATMAP_SHADES` 0% 색상을 `#F0F4FF`로 수정
  - S-curve 변환 제거하여 선형 매핑으로 변경
- **결과**: 퍼센트 값에 따른 정확한 색상 그라데이션 구현

### 기술적 개선사항
- **코드 정리**: 사용하지 않는 `qtype_questions` 변수 제거
- **성능 최적화**: 불필요한 문항 제목 처리 로직 제거
- **일관성**: 모든 문항 유형에 대한 일관된 분류 로직 적용

### 들여쓰기 오류 수정
- **문제**: IndentationError 발생 (line 3299)
- **원인**: else 문 다음의 들여쓰기 문제
- **해결**: 들여쓰기 수정으로 문법 오류 해결
- **결과**: 보고서 생성 정상 동작 확인

## 2025-01-11: 색상 팔레트 시스템 대폭 개선

### 주요 변경사항

#### 1. 색상 팔레트 통합 및 재구성
- **HEATMAP_SHADES → PRIMARY_PALETTE**: 기존 11단계 색상을 메인 팔레트로 승격
- **기존 PRIMARY_PALETTE 제거**: 5단계 색상 팔레트 삭제
- **CONTRAST_PALETTE 재설계**: #EF4444를 80% 색으로 하는 11단계 레드 계열 팔레트
- **GRAYSCALE_SHADES → GRAYSCALE_PALETTE**: 이름 통일

#### 2. COLOR_CONFIG 시스템 도입
```python
COLOR_CONFIG = {
    "heatmap": {"total_colors": 11, "start_index": 0, "end_index": 10},
    "pick_1_color": {"total_colors": 1, "indices": [8]},  # 80% 색상
    "pick_2_colors": {"total_colors": 2, "indices": [7, 9]},  # 70%, 90% 색상
    "pick_3_colors": {"total_colors": 3, "indices": [5, 7, 9]},  # 50%, 70%, 90% 색상
    "pick_4_colors": {"total_colors": 4, "indices": [3, 5, 7, 9]},  # 30%, 50%, 70%, 90% 색상
    "pick_5_colors": {"total_colors": 5, "indices": [2, 3, 5, 7, 9]},  # 20%, 30%, 50%, 70%, 90% 색상
    "pick_6_colors": {"total_colors": 6, "indices": [2, 3, 5, 6, 7, 9]},  # 20%, 30%, 50%, 60%, 70%, 90% 색상
    "pick_7_colors": {"total_colors": 7, "indices": [2, 3, 5, 6, 7, 8, 9]},  # 20%, 30%, 50%, 60%, 70%, 80%, 90% 색상
}
```

#### 3. 응답통계 색상 시스템 개선
- **모든 문항 유형**: PRIMARY_PALETTE 기반 색상 적용
- **색상 선택 로직**: COLOR_CONFIG의 pick_N_colors 설정 사용
- **중간값 기준**: 60% 색상(#6C87FE)을 중심으로 확장
- **항목 수별 최적화**: 1~7개 항목에 대한 특화된 색상 인덱스 매핑

#### 4. 기타응답요약 및 주관식요약 색상 통합
- **3개 팔레트 활용**: PRIMARY_PALETTE, CONTRAST_PALETTE, GRAYSCALE_PALETTE
- **각 팔레트에서 1색씩**: pick_1_color 설정 사용 (80% 색상)
- **긍정**: PRIMARY_PALETTE[8] (#2539E9)
- **부정**: CONTRAST_PALETTE[8] (#EF4444)
- **중립**: GRAYSCALE_PALETTE[8] (#B7C1D5)

#### 5. 키 이름 통일
- **기존**: single_color, stats_1_item (중복)
- **변경 후**: pick_1_color, pick_2_colors, ..., pick_7_colors (일관된 명명)

### 기술적 개선사항
- **중앙 집중식 색상 관리**: COLOR_CONFIG를 통한 체계적 색상 구성
- **확장성**: 새로운 색상 구성 추가 용이
- **일관성**: 모든 색상 팔레트가 _PALETTE 접미사로 통일
- **유지보수성**: 색상 관련 설정이 한 곳에 집중

### 이분형 문항 데이터 구조 확인
## 2025-09-16: 엣지케이스 시각 강조 방식 개편 및 정리

### 변경사항
- 엣지케이스 하이라이트를 `<tr>` 외곽선/셀 밑줄에서 “값 바(bar)” 배경색으로 변경
  - 값 바 기본 회색 `#D1D5DB` → 엣지케이스 시 20% 레드 `#FECACA`
- 모든 히트맵에서 엣지케이스 밑줄(`text-decoration:underline`) 제거
- 기존 빨간 외곽선(border) 방식은 이메일 호환성 문제로 미사용, 필요 시 `box-shadow`만 제한적으로 유지(데이터 셀 테두리 강조용)

### 추가 최적화 (중복 로직 정리)
- 불필요한 엣지케이스 보더 주입 루프들 제거(동일 기능 반복 코드 삭제)
- 빈 `row_attr` 변수 제거로 문자열 연산 최소화

### 영향
- 이메일 클라이언트(특히 Outlook)에서 시각적 일관성 향상
- 행 전체 강조 대신 세그 값 바만 강조되어 가독성 개선

### 검증
- 보고서 재생성 후 HTML에서 `text-decoration:underline` 0건 확인
- `background-color:#FECACA;` 다수 확인 (1of2/2of2 모두 반영)

- **문항 타입 코드**: 70 (binary)
- **숫자 값**: 0 = "맞아요" (긍정), 1 = "아니예요" (부정)
- **데이터 필드**: lkng_cntnt (숫자), answ_cntnt (텍스트 라벨)

## 2025-01-17: 주관식 분석 로직 대폭 개선

### 주요 변경사항

#### 1. 감정 분류 확장
- **기존**: 긍정, 부정, 중립 (3가지)
- **변경**: 긍정, 부정, 제안, 문의, 무응답 (5가지)
- **영향**: 더 세밀한 감정 분석 및 키워드 분류 가능

#### 2. 키워드 분류 체계 개선
- **기존**: 긍정 키워드, 부정 키워드, 중립 키워드
- **변경**: 긍정 키워드, 부정 키워드, 제안 키워드, 문의 키워드, 무응답 키워드
- **표시**: 막대그래프에서 무응답 행 제거, 무응답 키워드 열 제거

#### 3. 카테고리 로직 개선
- **제거**: "단순응답" 카테고리 완전 제거
- **추가**: "무응답" 카테고리 추가 (카테고리가 "무응답"이거나 sentiment가 "무응답"인 경우)
- **통합**: "기타 피드백" → "기타"로 통합
- **정렬**: 일반 카테고리들 → 기타 → 무응답 순서로 고정

#### 4. 카테고리 필드 변경
- **기존**: `llm_category` 사용
- **변경**: `llm_level1` 사용 (시각화 기준)
- **제외**: `llm_level2` 제외

#### 5. 카테고리명 정리
- **제거**: "NN. " 접두사 제거 (예: "1. 서비스 만족" → "서비스 만족")
- **정규식**: `re.sub(r'^\d+\.\s*', '', cat)` 적용

#### 6. 응답 길이 필터링
- **환경변수**: `MIN_RESPONSE_LENGTH = 5` 추가
- **기능**: `answ_cntnt` 길이가 5자 미만인 응답은 분석에서 제외
- **목적**: 의미 없는 짧은 응답 제거로 분석 품질 향상

#### 7. 시각적 개선
- **대시 라인**: 기타 위에 대시 스타일 구분선 추가
- **테이블 헤더**: "긍정/부정/제안/문의 수"로 변경
- **콜그룹**: 키워드 열을 5개에서 4개로 조정 (무응답 키워드 열 제거)
- **colspan**: 8에서 7로 조정

### 기술적 세부사항

#### 함수별 주요 변경
1. **`aggregate_subjective_by_category`**:
   - 감정 분류를 5가지로 확장
   - 무응답 로직 추가
   - 카테고리명 정리 로직 추가
   - 응답 길이 필터링 추가
   - 정렬 로직 개선 (기타/무응답 고정)

2. **`build_subjective_section`**:
   - 막대그래프에서 무응답 행 제거
   - 무응답 키워드 열 제거
   - 테이블 헤더 업데이트
   - 콜그룹 조정

3. **`build_other_responses_summary`**:
   - 동일한 변경사항 적용
   - 일관된 시각화 제공

4. **`_extract_comments_for_segment_combination`**:
   - `llm_category` → `llm_level1` 변경
   - 카테고리명 정리 로직 추가
   - 응답 길이 필터링 추가

5. **`_analyze_segment_responses_in_other_questions`**:
   - 동일한 변경사항 적용

#### 환경변수 추가
```python
MIN_RESPONSE_LENGTH = 5  # 최소 응답 길이 (자)
```

#### 제외 카테고리 업데이트
```python
SUBJECTIVE_EXCLUDE_CATEGORIES = {
    "무응답", "기타", "긍정반응", "서비스만족", "감사"
}
```

### 결과 및 효과
- **분석 정확도 향상**: 5가지 감정 분류로 더 세밀한 분석
- **데이터 품질 개선**: 짧은 응답 필터링으로 의미 있는 데이터만 분석
- **시각적 개선**: 무응답 관련 요소 제거로 깔끔한 표시
- **사용자 경험**: 카테고리명 정리로 가독성 향상
- **일관성**: 모든 관련 함수에서 동일한 로직 적용

### 테스트 결과
- 스크립트 실행 성공: 2개 보고서 파일 생성
- 무응답 관련 요소 제거 확인
- 기타/무응답 순서 고정 확인
- 대시 라인 위치 확인 (기타 위)
- 콜그룹 4개 열 확인

---

## 2025-01-23 히트맵 디자인 개선 및 기타열 색상 수정

### 작업 개요
히트맵의 레이아웃과 디자인을 개선하고, 기타열 색상을 고정하여 더욱 일관되고 깔끔한 디자인을 구현했습니다.

### 주요 변경사항

#### 1. 스페이서 열 레이아웃 개선
- **스페이서 열 고정**: 2개의 스페이서 열을 20px로 고정
- **히트맵 열 배분**: 나머지 공간을 히트맵 열들이 1fr씩 균등 배분
- **반응형 레이아웃**: 화면 크기에 따라 자동으로 조정되는 유연한 레이아웃

#### 2. 대시라인 디자인 적용
- **스페이서 열 대시라인 제거**: 투명 처리로 깔끔한 구분
- **세그간 구분선 대시라인**: `repeating-linear-gradient`를 사용한 대시라인 패턴
- **일관된 시각적 구분**: 모든 히트맵에서 동일한 대시라인 스타일 적용

#### 3. 평가형 히트맵 구분선 수정
- **동적 colspan 계산**: `6 + len(order)` 공식으로 정확한 열 수 계산
- **완전한 구분**: Top3와 평균점수 열까지 포함한 완전한 세그간 구분
- **라벨 개수 대응**: 라벨 개수에 관계없이 정확한 구분선 표시

#### 4. 기타열 색상 고정
- **고정 색상**: `_shade_for_other_column` 함수에서 항상 #D1D5DB 반환
- **일관된 표시**: 퍼센트에 관계없이 동일한 색상으로 표시
- **명확한 구분**: 기타열이 다른 열들과 시각적으로 명확하게 구분

#### 5. 구분선 두께 조정
- **세밀한 구분**: 세그간 구분선 두께를 2px에서 1px로 변경
- **정교한 디자인**: 과도하지 않은 두께로 시각적 균형 확보

### 수정된 함수
- `build_general_heatmap_only`: 일반형 히트맵
- `build_evaluation_heatmap_only`: 평가형 히트맵
- `build_objective_evaluation_heatmap`: 객관식 평가형 히트맵
- `build_objective_general_heatmap`: 객관식 일반형 히트맵
- `_shade_for_other_column`: 기타열 색상 함수

### 시각적 개선 효과
- **깔끔한 디자인**: 대시라인과 고정 색상으로 일관된 시각적 표현
- **명확한 구분**: 세그간 구분이 더욱 뚜렷하게 표시
- **균등한 배분**: 히트맵 열들이 균등하게 공간을 차지
- **일관된 색상**: 기타열의 고정 색상으로 시각적 통일성 확보

### 테스트 결과
- 스크립트 실행 성공: 2개 보고서 파일 생성
- 스페이서 열 20px 고정 확인
- 히트맵 열 1fr씩 배분 확인
- 대시라인 구분선 적용 확인
- 평가형 히트맵 완전한 구분선 확인 (colspan="13")
- 기타열 #D1D5DB 색상 고정 확인
- 1px 구분선 두께 확인
